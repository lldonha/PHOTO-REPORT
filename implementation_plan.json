{
  "feature": "Multi-Project (Obra) Management",
  "workflow_type": "feature",
  "workflow_rationale": "This is a significant new feature that introduces a new domain entity (Obra/Project), requires database schema changes, API endpoints, and frontend UI components. It follows the feature workflow with backend first, then frontend, then integration phases.",
  "phases": [
    {
      "id": "phase-1-backend-model",
      "name": "Backend Model & Repository",
      "type": "implementation",
      "description": "Create Obra SQLAlchemy model, Pydantic schemas, and repository pattern",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Create Obra SQLAlchemy model following PhotoReport pattern",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": ["src/models/obra.py", "src/models/__init__.py"],
          "patterns_from": [".worktrees/004-persist-ncia-real-no-postgresql/src/models/photo_report.py", ".worktrees/004-persist-ncia-real-no-postgresql/src/models/base.py"],
          "verification": {
            "type": "command",
            "command": "python -c \"from src.models.obra import Obra; print('Obra model OK')\"",
            "expected": "Obra model OK"
          },
          "status": "pending",
          "notes": "Model fields: id (UUID), nome (str, required), endereco (str, optional), cliente (str, optional), status (str, default 'ativa'), created_at, updated_at. Use TimestampMixin."
        },
        {
          "id": "subtask-1-2",
          "description": "Create Obra Pydantic schemas (Base, Create, Update, Response, ListResponse)",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": ["src/schemas/obra.py", "src/schemas/__init__.py"],
          "patterns_from": [".worktrees/004-persist-ncia-real-no-postgresql/src/schemas/photo_report.py"],
          "verification": {
            "type": "command",
            "command": "python -c \"from src.schemas.obra import ObraCreate, ObraResponse; print('Schemas OK')\"",
            "expected": "Schemas OK"
          },
          "status": "pending",
          "notes": "ObraCreate: nome (required), endereco (optional), cliente (optional). ObraUpdate: all optional. ObraResponse: all fields plus report_count."
        },
        {
          "id": "subtask-1-3",
          "description": "Create ObraRepository with CRUD operations and status filter",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": ["src/repositories/obra_repository.py", "src/repositories/__init__.py"],
          "patterns_from": [".worktrees/004-persist-ncia-real-no-postgresql/src/repositories/photo_report_repository.py"],
          "verification": {
            "type": "command",
            "command": "python -c \"from src.repositories.obra_repository import ObraRepository; print('Repository OK')\"",
            "expected": "Repository OK"
          },
          "status": "pending",
          "notes": "Methods: create, get_by_id, list (with status filter), update, archive (sets status='arquivada'), count. Include logging."
        }
      ]
    },
    {
      "id": "phase-2-database-migration",
      "name": "Database Migration",
      "type": "implementation",
      "description": "Create Alembic migration for obras table and photo_reports FK",
      "depends_on": ["phase-1-backend-model"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Create Alembic migration for obras table and add obra_id FK to photo_reports",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": ["alembic/versions/002_add_obras.py"],
          "patterns_from": [".worktrees/004-persist-ncia-real-no-postgresql/alembic/versions/001_initial.py"],
          "verification": {
            "type": "command",
            "command": "test -f alembic/versions/002_add_obras.py && echo 'Migration file created'",
            "expected": "Migration file created"
          },
          "status": "pending",
          "notes": "Table: obras (id UUID PK, nome VARCHAR(255) NOT NULL, endereco VARCHAR(500), cliente VARCHAR(255), status VARCHAR(50) DEFAULT 'ativa', created_at, updated_at). Add obra_id FK to photo_reports as nullable initially. Create indexes: idx_obras_status, idx_obras_nome."
        }
      ]
    },
    {
      "id": "phase-3-backend-api",
      "name": "Backend API Endpoints",
      "type": "implementation",
      "description": "Create REST API endpoints for Obras CRUD operations",
      "depends_on": ["phase-1-backend-model"],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Create Obras API router with CRUD endpoints",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": ["src/api/v1/endpoints/obras.py", "src/api/v1/endpoints/__init__.py"],
          "patterns_from": [".worktrees/004-persist-ncia-real-no-postgresql/src/api/v1/endpoints/reports.py"],
          "verification": {
            "type": "command",
            "command": "python -c \"from src.api.v1.endpoints.obras import router; print('Router OK')\"",
            "expected": "Router OK"
          },
          "status": "pending",
          "notes": "Endpoints: POST /obras (create), GET /obras (list with ?status filter), GET /obras/{id} (get by id), PUT /obras/{id} (update), PUT /obras/{id}/arquivar (archive), GET /obras/{id}/reports (list reports by obra)."
        },
        {
          "id": "subtask-3-2",
          "description": "Register obras router in main.py and update API v1 router",
          "service": "backend",
          "files_to_modify": ["src/main.py", "src/api/v1/__init__.py"],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "api",
            "method": "GET",
            "url": "http://localhost:8002/docs",
            "expected_status": 200
          },
          "status": "pending",
          "notes": "Include obras router with prefix /api/v1/obras. Ensure CORS is configured."
        }
      ]
    },
    {
      "id": "phase-4-backend-tests",
      "name": "Backend Unit Tests",
      "type": "implementation",
      "description": "Create unit tests for Obra model, repository, and API endpoints",
      "depends_on": ["phase-3-backend-api"],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Create unit tests for ObraRepository CRUD operations",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": ["tests/test_obras.py"],
          "patterns_from": ["tests/test_api.py"],
          "verification": {
            "type": "command",
            "command": "test -f tests/test_obras.py && echo 'Test file created'",
            "expected": "Test file created"
          },
          "status": "pending",
          "notes": "Tests: test_criar_obra, test_listar_obras, test_atualizar_obra, test_arquivar_obra, test_obra_validation. Use pytest fixtures."
        }
      ]
    },
    {
      "id": "phase-5-frontend-ui",
      "name": "Frontend UI Components",
      "type": "implementation",
      "description": "Add project selector dropdown and management modal to frontend",
      "depends_on": ["phase-3-backend-api"],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "Add project selector dropdown to main interface above dropzone",
          "service": "frontend",
          "files_to_modify": ["src/frontend/index.html"],
          "files_to_create": [],
          "patterns_from": [".worktrees/001-criar-sistema-photo-report-completo/src/frontend/index.html"],
          "verification": {
            "type": "browser",
            "url": "http://localhost:8080",
            "checks": ["Project selector dropdown visible above dropzone", "Dropdown populated with obras from API", "No console errors"]
          },
          "status": "pending",
          "notes": "Add obra selector section with dropdown. Update state to include obras and obraAtual. Add carregarObras() function. Show 'Criar Primeira Obra' button if no obras exist."
        },
        {
          "id": "subtask-5-2",
          "description": "Add project creation/management modal with form",
          "service": "frontend",
          "files_to_modify": ["src/frontend/index.html"],
          "files_to_create": [],
          "patterns_from": [".worktrees/001-criar-sistema-photo-report-completo/src/frontend/index.html"],
          "verification": {
            "type": "browser",
            "url": "http://localhost:8080",
            "checks": ["Nova Obra button opens modal", "Form has nome, endereco, cliente fields", "Submit creates obra via API", "Modal closes on success"]
          },
          "status": "pending",
          "notes": "Modal with form: Nome (required), Endereco (optional), Cliente (optional). Submit button calls criarObra(). Cancel button closes modal. Show toast on success/error."
        },
        {
          "id": "subtask-5-3",
          "description": "Update report generation to include selected obra",
          "service": "frontend",
          "files_to_modify": ["src/frontend/index.html"],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "browser",
            "url": "http://localhost:8080",
            "checks": ["Selected obra name shown in report config", "PDF generation includes obra info"]
          },
          "status": "pending",
          "notes": "Update gerarPdf() to use selected obra name. Pre-fill 'obra' input field with selected obra name. Store obraAtual in state for session persistence."
        }
      ]
    },
    {
      "id": "phase-6-integration",
      "name": "Integration & E2E Verification",
      "type": "integration",
      "description": "Wire all components together and verify end-to-end functionality",
      "depends_on": ["phase-4-backend-tests", "phase-5-frontend-ui"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-6-1",
          "description": "Integration test: Create obra, select it, upload photos, generate PDF",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Open frontend at http://localhost:8080",
              "Click 'Nova Obra' and create a new obra with name/address/client",
              "Verify obra appears in dropdown selector",
              "Select the created obra from dropdown",
              "Upload test photos via dropzone",
              "Generate PDF and verify obra name appears in report",
              "Verify no console errors in browser",
              "Verify no errors in backend logs"
            ]
          },
          "status": "pending",
          "notes": "Full end-to-end test of the obra management feature. Document any issues found."
        },
        {
          "id": "subtask-6-2",
          "description": "Verify database state: obras table, FK constraints, indexes",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Connect to PostgreSQL and verify: 1) obras table exists with correct columns, 2) photo_reports has obra_id FK, 3) indexes exist (idx_obras_status, idx_obras_nome)"
          },
          "status": "pending",
          "notes": "Database verification step. Run after migration is applied."
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 6,
    "total_subtasks": 10,
    "services_involved": ["backend", "frontend", "postgresql"],
    "parallelism": {
      "max_parallel_phases": 2,
      "parallel_groups": [
        {
          "phases": ["phase-3-backend-api", "phase-2-database-migration"],
          "reason": "Both depend only on phase-1, different concerns (API code vs DB schema)"
        },
        {
          "phases": ["phase-4-backend-tests", "phase-5-frontend-ui"],
          "reason": "Both depend on phase-3, different services (backend tests vs frontend UI)"
        }
      ],
      "recommended_workers": 1,
      "speedup_estimate": "Sequential execution recommended due to database dependencies"
    },
    "startup_command": "source .venv/bin/activate && python auto-claude/run.py --spec 010 --parallel 1"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "phase-4-backend-tests",
    "test_types_required": ["unit", "integration"],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "All existing tests pass (pytest tests/ -v)",
      "New obra tests pass (pytest tests/test_obras.py -v)",
      "API endpoints respond correctly (curl verification)",
      "Frontend displays obra selector without console errors",
      "Database schema matches specification"
    ],
    "verification_steps": [
      {
        "name": "Unit Tests",
        "command": "pytest tests/ -v --tb=short",
        "expected_outcome": "All tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "API Health Check",
        "command": "curl -s http://localhost:8002/health | grep -q 'ok' && echo 'API OK'",
        "expected_outcome": "API OK",
        "type": "api",
        "required": true,
        "blocking": true
      },
      {
        "name": "Obras Endpoint Check",
        "command": "curl -s http://localhost:8002/api/v1/obras | grep -q '\\[' && echo 'Obras endpoint OK'",
        "expected_outcome": "Obras endpoint OK",
        "type": "api",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "Medium risk due to database schema changes. Unit tests for repository logic, API endpoint verification, and browser testing required. No authentication changes, so security scan not needed."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": ["pytest tests/test_obras.py -v"],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": ["pytest tests/ -v -k integration"],
      "services_to_test": ["backend", "postgresql"]
    },
    "e2e_tests": {
      "required": true,
      "commands": [],
      "flows": ["create-obra", "select-obra-upload-photos", "archive-obra"]
    },
    "browser_verification": {
      "required": true,
      "pages": [
        {"url": "http://localhost:8080", "checks": ["obra-selector-visible", "no-console-errors", "modal-opens"]},
        {"url": "http://localhost:8002/docs", "checks": ["obras-endpoints-listed"]}
      ]
    },
    "database_verification": {
      "required": true,
      "checks": ["obras-table-exists", "photo-reports-fk-exists", "indexes-created"]
    }
  },
  "qa_signoff": null
}
